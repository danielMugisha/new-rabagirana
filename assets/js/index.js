const defaultStories = [
	{
		_id: 1,
		title: "Umusozi w'Ubumwe",
		summary: `Rusheshe community was known for disunity, disputes, lack of interest in government programs...`,
		content: `Rusheshe community was known for disunity, disputes, lack of interest in government programs such as medical insurance for all, every child in school and other good government targets. From January 2021, Rabagirana Ministry adopted Rusheshe as a model community where Rwandans and other countries will come and experience authentic healing, forgiveness and reconciliation. In our first meeting, Isaiah 11 was our theme with through pillars: God is the true source of lasting and reconciliation The church should be an agent of God's restoration in the community When the Kingdom of God comes, former enemies should be working together towards a peaceful and prosperous future. Today, Rusheshe has been renamed ' Umusozi w'Ubumwe' or the Unity Mountain. Unity groups made of all social strata meet to share their pain and joys, visit each other, learn skills together and do small businesses to tackle poverty. Rachel, the leader of the committee says: 'God has taken away the shame over our community. I am now proud to belong here.' One local government leader said 'I considered it a blessing when I was sent to work elsewhere from this extremely difficult community.' Today as I listen to perpetrators and survivors, to exiles and those who lived here, I am moved.' One guest from the US: 'as an African American, I came in Rwanda with doubt. I could not believe true reconciliation is possible. I am amazed at Umusozi w'Ubumwe to see how Rwanda are 're-humanizing' one another, including people who committed terrible atrocities.'`,
		narrator: "Rabagirana",
		image: "assets/images/stories/Umusozi.jpg",
	},
	{
		_id: 2,
		title: "Keza's story…",
		summary: `The month was July, the day was a Saturday, and the time was half-past midday. A joyous Keza Angelique...`,
		content: `The month was July, the day was a Saturday, and the time was half-past midday. A joyous Keza Angelique, a single mother of three, is humming to a hymn from the radio as she warms 'isombe' (cassava leaves) for lunch, using her newly purchased gas cooker. With a green colourful 'kitenge' (wrapper) around her waist and a bandana of the same colour covering her head, she turns to us and asks, "do you want to know the secret ingredient to my tasty isombe?" "Love!" my colleague immediately yelled. "No. Love doesn't make my isombe sweet. What's wrong with you?" She replied playfully, making us all burst into laughter. After she was done warming the isombe, she got ready to prepare 'ugali' (sorghum flour). She sprinkled the flour into the boiling water while briskly stirring it with a cooking stick to make it thicker. In a very short time, the ugali was ready and it was time to eat. As we sat by the dining table to devour the tasty meal that lay helplessly before us, Keza signalled that she wanted to say something. My colleague and I immediately had one of those telepathic communications, questioning Keza's poor timing. "One doesn't give speeches before the meal…speeches usually take place after the meal!" he seemed to say. "Her house, her rules I guess," I signalled back.  So, we sat quietly and listened to her.

		"Thank you, Rabagirana Ministries for the gas cooker. Cooking over the traditional three-stone open fire was a health hazard to me. It used to make me cough a lot and the smoke would hurt my eyes too... giving me teary eyes with a running nose.  But this gas produces no smoke and since I started using it, I do not cough anymore."
		
		Keza is one of many community members positively impacted by the creation care program of Rabagirana Ministries. Earlier last month we partnered with some local cooperatives to purchase gas cookers, and build wood-saving, earth-block stoves popularly known as the energy-saving stoves for the members of the community. As compared to the widely used traditional three-stone open hearth, these alternatives are already transforming the way people cook in rural communities.`,
		narrator: "Rabagirana",
		image: "assets/images/stories/Gas.jpeg",
	},
	{
		_id: 3,
		title: "Ubumwe football",
		summary: `Ubumwe football is a team of single mothers that came together after attending healing heart transforming...`,
		content: `Ubumwe football is a team of single mothers that came together after attending healing heart transforming nation workshop (HHTN). it started in 2021 February and they are 20 members.
		These women were hopeless of the future and wounded because they were rejected by their families but after HHTN workshop, they discovered that GOD always has hope even if we don't, then they decided to start Football team, they saved some little amount of money on weekly basis, Right now they have an income generating activity of livestock of pigs in a program called Pig Per Player Project (4P's). These women normally survive on small business of selling vegetables (street vendors) 4 of them have had chance to get legally married as a result of healing from past experiences in the football team.
		UBUMWE FC has been able to spread the message since it started, the team has played with many teams such as, COERSO tourist Students from SWTZLAND, Eleven football Academy, Africa Rise Team , Forum of reconciliation, Gatenga women football team in Umurenge Kagame Cup, and many more. these different activities helped them to developed in social and economic welfare.
		The vision is to see their team being the channel of spreading the message of peace in the community, it is their desire to become competent at national and international level and holistic transformation to their life.`,
		narrator: "Rabagirana",
		image: "assets/images/stories/ubumwe-football.jpg",
	},
	{
		_id: 4,
		title: "Mutesi's story",
		summary: `Mutesi is a genocide survivor who is the only survivor in her family, after the genocide she...`,
		content: `Mutesi is a genocide survivor who is the only survivor in her family, after the genocide she lived a hopeless and miserable life, she lived a lonely life and trusted no one on both Hutu side and Tutsi side. she later on joined our workshop and found freedom,dealt with her pain. Mukeshimana is a wife of an Ex perpetrator, in otherwise the husband killed many people during the Genocide. her husband was imprisoned for 28 years. she lived in denial, guilt and dispair. after going through the healing workshop she felt peace and even received Jesus Christ in the process. now these two ladies joined many more with the same stories through Rabagirana and started a cooperative (Ubumwe crafts) these ladies were trained to make crafts which includes jewellery, baskets, different african print decorations, cultural objects with a meaning. they are now able to generate some little income and are able to provide for their families but most importantly while working on the crafts together, they get an opportunity to share life and experiences as they counsel each other.`,
		narrator: "Rabagirana",
		image: "assets/images/stories/mutesi.jpg",
	},
	{
		_id: 5,
		title: "Alex's story",
		summary: `My name is Mukunzi Alex, and I came very close to committing suicide last month. Here's my story...`,
		content: `My name is Mukunzi, and I came very close to committing suicide last month. Here's my story:
		My father is a typical alpha male who does not tolerate weakness of any kind. I was not allowed to talk about my feelings. "Talking about your feelings is for women," he would say. He taught me to bottle up my feelings from when I was a little boy. I reached my breaking point when I went through a near-death experience after getting involved in an accident, but I still wasn't permitted to talk about it. That was when I decided that it would be better to be dead than live such a miserable life.
		It was shortly after contemplating suicide that I bumped into a friend who told me about the counseling sessions at Rabagirana Ministries on Tuesdays and Thursdays. I was reluctant at first because, in the back of my mind, I knew if my father found out, he would be very disappointed in me. Nonetheless, my friend, whose father is also a soldier, insisted, and I decided to give it a try. That one counseling session was life-transforming. I was allowed to speak about everything without judgment. The counselor was both empathetic and sympathetic, something I have never experienced from my father. Since then, I have been regulary attending counseling.
		 Thank you, RM, for without you, I would be six feet deep.`,
		narrator: "Alex Mukunzi",
		image: "assets/images/stories/mukunzi-alex.jpg",
	},
	{
		_id: 6,
		title: "The Healing Saloon",
		summary: `Meet Mukeshimana Claudine; she is a wife, a mother of four, a hairdresser, and of recent, a healing`,
		content: `Meet Mukeshimana Claudine; she is a wife, a mother of four, a hairdresser, and of recent, a healing and
		reconciliation practitioner! Rabagirana Ministries (RM) got to know about Claudine a few months ago when she
		enrolled for our annual Vocational training school. Before taking the hairdressing class, Claudine narrates how
		miserable life was; "I was unemployed for as long as I can remember" she begins. "My husband and I used to
		struggle daily to provide for our kids their basic needs. It was a very tough time. This however, is now all in the
		past!" she concludes with a smile.
		After her completion of the course, Claudine didn't take long before she landed her first job. She now works at
		Magic Salon, which is also known by the locals as the "healing salon." The nickname "healing salon" came from
		the fact that people actually felt better after spending time in that salon and Claudine was the party behind that.
		After going through the healing and reconciliation workshop, Claudine recalls experiencing a deep healing of all
		her wounds and she vowed to use whatever platform God was going to give her to share her experience. So,
		when the opportunity presented itself, she took it. She would offer compassionate hearing to her clients and
		allow them to share their hurts and release their tears. Many women, old and young alike, have now received the
		healing message, and for majority of them, it changed their outlook on life.
		It is now very clear that most Rwandans are not asking if healing is possible but where can they find it? We
		want to encourage every church, school, business, and even homes to be used as a 'healing space!'`,
		narrator: "Rabagirana",
		image: "assets/images/stories/Healing-saloon.jpg",
	},
];

// Keep track of current stories, initialized with defaults
let currentStories = [...defaultStories];

// Added an event listener for DOMContentLoaded to ensure early initialization
document.addEventListener('DOMContentLoaded', function() {
  // Initialize basic UI elements that don't depend on data
  setupEventListeners();
  // Try to initialize carousel early with default stories
  buildStories();
});

// Refactoring window.onload to maintain reference to the original code but reorganize timing
window.onload = function() {
  getBaseUrl();
  
  // Check if we're on the story page
  if (window.location.pathname.includes('story.html')) {
    displayStory();
  } else {
    // Existing homepage initialization
    cleanupCarousel();
    getMannaContent();
    getEvents();
    getStories();
  }
};

// New function to setup event listeners - extracted from window.onload
function setupEventListeners() {
  var hero = document.getElementById("hero");
  var video = document.getElementById("myVideo");
  var soundBtn = document.getElementById("sound-btn");
  var muteBtn = document.getElementById("mute-btn");
  
  if (video && soundBtn && muteBtn) {
    // Set initial button states based on video muted property
    if(video.muted) {
      soundBtn.className = 'video-active';
      muteBtn.className = 'video-inactive';
    } else {
      soundBtn.className = 'video-inactive';
      muteBtn.className = 'video-active';
    }
    
    // Video hover shows appropriate buttons
    video.addEventListener("mouseover", function () {
      if(video.muted) {
        soundBtn.className = 'video-active';
        muteBtn.className = 'video-inactive';
      } else {
        soundBtn.className = 'video-inactive';
        muteBtn.className = 'video-active';
      }
    });
    
    // Hide buttons when mouse leaves video
    video.addEventListener("mouseleave", function () {
      soundBtn.className = 'video-inactive';
      muteBtn.className = 'video-inactive';
    });
    
    // Sound button click - unmute video
    soundBtn.addEventListener("click", function(e) {
      e.stopPropagation(); // Prevent event from bubbling to parent containers
      video.muted = false;
      soundBtn.className = 'video-inactive';
      muteBtn.className = 'video-active';
    });
    
    // Mute button click - mute video
    muteBtn.addEventListener("click", function(e) {
      e.stopPropagation(); // Prevent event from bubbling to parent containers
      video.muted = true;
      muteBtn.className = 'video-inactive';
      soundBtn.className = 'video-active';
    });
    
    // Video click - toggle mute state
    video.addEventListener("click", function(e) {
      // Only handle clicks directly on the video, not on buttons
      if (e.target === video) {
        if(video.muted) {
          video.muted = false;
          soundBtn.className = 'video-inactive';
          muteBtn.className = 'video-active';
        } else {
          video.muted = true;
          muteBtn.className = 'video-inactive';
          soundBtn.className = 'video-active';
        }
      }
    });
  }
}

// New function to explicitly clean up any existing carousel
function cleanupCarousel() {
  var el = document.getElementById("stories");
  // Check if both the element exists and jQuery + Flickity are available
  if (el && typeof $ !== 'undefined' && $ && typeof $.fn !== 'undefined' && $.fn.flickity) {
    const $carousel = $(el);
    if ($carousel.data('flickity')) {
      try {
        $carousel.flickity('destroy');
      } catch (error) {
        console.error('Error destroying flickity:', error);
      }
    }
  }
}

let apiURL = "";

const getBaseUrl = () => {
  apiURL = "https://app.rabagirana.org/";
};

// Custom slider for Stories
const buildStories = async () => {
  const storySlider = document.getElementById("stories");
  if (!storySlider) return; // Safety check if element doesn't exist
  
  // Clear existing content
  storySlider.innerHTML = "";
  
  // Build HTML for each story
  currentStories.forEach((story) => {
    const storySlide = document.createElement('div');
    storySlide.className = 'story-slide';
    
    storySlide.innerHTML = `
      <article class="lqd-pf-item cursor-pointer" onclick="window.location.href='story.html?id=${story._id}'">
        <div class="lqd-pf-item-inner">
          <div class="lqd-pf-img overflow-hidden rounded-6 relative" >
            <figure>
              <img
                width="400"
                height="400"
                src="${story.image}"
                class="w-full h-full objfit-cover objfit-center"
                alt="${story.title}"
              />
            </figure>
            <div class="lqd-pf-overlay-bg flex flex-col items-center justify-between py-4 px-3">
              <div class="text-center mb-auto">
                <h2 class="text-white text-xl font-bold mb-2">${story.title}</h2>
                <p class="text-white text-sm italic">By ${story.narrator}</p>
              </div>
              <p class="text-white text-center">${story.summary}</p>
            </div>
          </div>
        </div>
      </article>
    `;
    
    storySlider.appendChild(storySlide);
  });
  
  // Initialize the custom slider functionality
  initCustomSlider();
};

// Initialize custom slider functionality
function initCustomSlider() {
  const slider = document.getElementById('stories');
  const prevBtn = document.querySelector('.slider-prev');
  const nextBtn = document.querySelector('.slider-next');
  
  if (!slider || !prevBtn || !nextBtn) return;
  
  let slideWidth = 0;
  let slidesPerView = 4;
  let currentPosition = 0;
  const totalSlides = slider.children.length;
  
  // Determine slides per view based on viewport width
  function updateSlidesPerView() {
    if (window.innerWidth < 480) {
      slidesPerView = 1;
    } else if (window.innerWidth < 768) {
      slidesPerView = 2;
    } else if (window.innerWidth < 992) {
      slidesPerView = 3;
    } else {
      slidesPerView = 4;
    }
    
    // Update slide width based on container width and slides per view
    const sliderWrapper = slider.closest('.custom-slider-wrapper');
    if (sliderWrapper) {
      const containerWidth = sliderWrapper.clientWidth;
      slideWidth = containerWidth / slidesPerView;
      
      // Apply width to slides with minimal gap
      Array.from(slider.children).forEach(slide => {
        slide.style.width = `${slideWidth - 5}px`; // Reduced gap to 5px
      });
    }
    
    // Reset position when viewport changes
    goToSlide(0);
  }
  
  // Move slider to specified position
  function goToSlide(position) {
    currentPosition = position;
    
    // Ensure we don't go out of bounds
    if (currentPosition < 0) {
      currentPosition = 0;
    }
    
    const maxPosition = totalSlides - slidesPerView;
    if (currentPosition > maxPosition) {
      currentPosition = maxPosition > 0 ? maxPosition : 0;
    }
    
    // Apply transform
    slider.style.transform = `translateX(-${currentPosition * (slideWidth)}px)`;
  }
  
  // Handle next/prev button clicks
  nextBtn.addEventListener('click', () => {
    goToSlide(currentPosition + 1);
  });
  
  prevBtn.addEventListener('click', () => {
    goToSlide(currentPosition - 1);
  });
  
  // Initialize slider dimensions
  updateSlidesPerView();
  
  // Update on window resize
  window.addEventListener('resize', updateSlidesPerView);
}

const subscribe = async () => {
  const emailInput = document.getElementById('email');
  const userEmail = emailInput.value;
  
  if (!userEmail || !userEmail.includes('@')) {
    alert('Please enter a valid email address');
    return;
  }
  
  const url = `${apiURL}api/subscriptions/subscribe`;

  const data = {
    email: userEmail,
    status: 'subscribed'
  };

  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data)
    });

    const result = await response.json();

    if (response.ok) {
      alert(`Thank you for subscribing!`);
      emailInput.value = ''; // Clear the input field
    } else {
      alert(`Error: ${result.error || 'Subscription failed'}`);
    }
  } catch (error) {
    console.error('Subscription error:', error);
    alert('Sorry, there was a problem processing your subscription. Please try again later.');
  }
};


const buildManna = async (manna) => {
  var imageElement = document.getElementById('manna-image')
  var titleElement = document.getElementById('manna-title')
  var summaryElement = document.getElementById('manna-summary')
  var linkElement = document.getElementById('manna-link')

  if (!imageElement || !titleElement || !summaryElement || !linkElement) {
    console.error('One or more manna elements not found');
    return;
  }

  imageElement.src = `${apiURL}${manna.featuredImage}`
  titleElement.innerText = manna.title
  summaryElement.innerText = manna.summary
  linkElement.href = `manna.html?id=${manna._id}` 
}

const getMannaContent = async () => {
  const URL = `${apiURL}api/manna/latest`;
  try {
    const response = await fetch(URL);
    const result = await response.json();
    if (result.data) {
      buildManna(result.data);
    }
    return true;
  } catch (error) {
    console.error('Error fetching manna content:', error);
    return false;
  }
};


const getEvents = async () => {
  const URL = `${apiURL}api/events/latest`;
  
  // Show loading state immediately
  buildEvents([], true);

  try {
    const response = await fetch(URL);
    const result = await response.json();
    
    // Pass false for loading since we have the data now
    buildEvents(result.data, false);
  } catch (error) {
    console.error('Error fetching events:', error);
    // Show empty state when there's an error
    buildEvents([], false);
    return false;
  }
}

const buildEvents = async(events, isLoading = false) => {
  const el = document.getElementById('upcoming');
  if (!el) return;
  
  el.innerHTML = '';

  // Show loading state
  if (isLoading) {
    for (let i = 0; i < 3; i++) {
      el.innerHTML += `
      <div class="col col-12 col-md-6 col-xl-3 p-0 module-content">
        <div class="lqd-fb relative lqd-fb-style-6 rounded-4 h-pt-125 text-white" data-lqd-zindex="true">
          <div class="lqd-fb-shadow"></div>
          <div class="flex flex-wrap items-center lqd-overlay flex shimmer-effect">
            <div class="lqd-fb-content-wrap lqd-overlay flex flex-col items-end">
              <div class="lqd-fb-img lqd-overlay flex rounded-4 overflow-hidden"></div>
            </div>
          </div>
        </div>
      </div>`;
    }
    return;
  }

  // If we have events, show them
  if (events && events.length > 0) {
    events.forEach(event => {
      el.innerHTML += `<div class="col col-12 col-md-6 col-xl-3 p-0 module-content">
        <div class="lqd-fb relative lqd-fb-style-6 rounded-4 h-pt-125 text-white" data-lqd-zindex="true">
          <div class="lqd-fb-shadow"></div>
          <div class="flex flex-wrap items-center lqd-overlay flex" data-hover3d="true">
            <div class="lqd-fb-content-wrap lqd-overlay flex flex-col items-end transform-style-3d backface-hidden will-change-transform" data-stacking-factor="0.5">
              <div class="lqd-fb-img lqd-overlay flex rounded-4 overflow-hidden backface-hidden">
                <figure class="w-full h-full m-0">
                  <img class="w-full" src="${apiURL}${event.featuredImage}" alt="${event.title}" />
                </figure>
                <div class="lqd-fb-bg lqd-overlay flex"></div>
                <div class="lqd-fb-hover-overlay lqd-overlay flex bg-transparent" style="background-image: linear-gradient(180deg, rgba(243, 194, 72, 0.85) 0%, rgba(97, 151, 95, 0.85) 100%);"></div>
              </div>
              <div class="lqd-fb-content flex flex-col justify-end lqd-overlay flex backface-hidden py-1/5em px-1/5em">
                <span class="lqd-fb-icon flex mb-0/85em"><i aria-hidden="true" class="lqd-icn-ess icon-lqd-mobile"></i></span>
                <h6 class="mt-0 mb-1/35em font-bold">${new Date(event.startDate).toLocaleString()}</h6>
                <h2 class="lqd-fb__title mt-0 text-26 font-bold">${event.title}</h2>
              </div>
            </div>
          </div>
        </div>
      </div>`;
    });

    // Fill remaining slots if needed
    const count = 3 - events.length;
    for (let i = 0; i < count; i++) {
      el.innerHTML += `<div class="col col-12 col-md-6 col-xl-3 p-0 module-content">
        <div class="lqd-fb relative lqd-fb-style-6 rounded-4 h-pt-125 text-white" data-lqd-zindex="true">
          <div class="lqd-fb-shadow"></div>
          <div class="flex flex-wrap items-center lqd-overlay flex" data-hover3d="true">
            <div class="lqd-fb-content-wrap lqd-overlay flex flex-col items-end transform-style-3d backface-hidden will-change-transform" data-stacking-factor="0.5">
              <div class="lqd-fb-img lqd-overlay flex rounded-4 overflow-hidden ">
                <figure class="w-full h-full m-0">
                  <img class="w-full" src="https://fakeimg.pl/500x400?text=Coming+Soon" alt="Rabagirana" />
                </figure>
                <div class="lqd-fb-bg lqd-overlay flex"></div>
                <div class="lqd-fb-hover-overlay lqd-overlay flex bg-transparent" style="background-image: linear-gradient(180deg, rgba(243, 194, 72, 0.85) 0%, rgba(97, 151, 95, 0.85) 100%);"></div>
              </div>
              <div class="lqd-fb-content flex flex-col justify-end lqd-overlay flex backface-hidden py-1/5em px-1/5em">
                <span class="lqd-fb-icon flex mb-0/85em"><i aria-hidden="true" class="lqd-icn-ess icon-lqd-path"></i></span>
                <h6 class="mt-0 mb-1/35em font-bold">Coming Soon</h6>
                <h2 class="lqd-fb__title mt-0 text-26 font-bold">Stay Tuned</h2>
              </div>
            </div>
          </div>
        </div>
      </div>`;
    }
  } else {
    // Show single morphic card for no events
    el.innerHTML = `<div class="col col-12 col-md-6 col-xl-3 p-0 module-content mx-auto">
      <div class="lqd-fb relative lqd-fb-style-6 rounded-4 h-pt-60 text-white" data-lqd-zindex="true">
        <div class="lqd-fb-shadow"></div>
        <div class="flex flex-wrap items-center lqd-overlay flex" data-hover3d="true">
          <div class="lqd-fb-content-wrap lqd-overlay flex flex-col items-end transform-style-3d backface-hidden will-change-transform" data-stacking-factor="0.5">
            <div class="lqd-fb-img lqd-overlay flex rounded-4 overflow-hidden backface-hidden">
              <figure class="w-full h-full m-0">
                <img class="w-full" src="https://fakeimg.pl/800x400?text=Stay+Tuned" alt="Rabagirana" />
              </figure>
              <div class="lqd-fb-bg lqd-overlay flex"></div>
              <div class="lqd-fb-hover-overlay lqd-overlay flex bg-transparent" style="background-image: linear-gradient(180deg, rgba(243, 194, 72, 0.85) 0%, rgba(97, 151, 95, 0.85) 100%);"></div>
            </div>
            <div class="lqd-fb-content flex flex-col justify-end lqd-overlay flex backface-hidden py-1/5em px-1/5em">
              <span class="lqd-fb-icon flex mb-0/85em"><i aria-hidden="true" class="lqd-icn-ess icon-lqd-calendar"></i></span>
              <h6 class="mt-0 mb-1/35em font-bold">Stay Tuned</h6>
              <h2 class="lqd-fb__title mt-0 text-26 font-bold">Upcoming Events</h2>
            </div>
          </div>
        </div>
      </div>
    </div>`;
  }
}

const getStories = async () => {
  const URL = `${apiURL}api/stories`;
  try {
    const response = await fetch(URL);
    const result = await response.json();
    if (result.data && result.data.length > 0) {
      // If stories are fetched successfully, update currentStories
      currentStories = result.data;
      defaultStories = result.data;
      buildStories();
    }
    return true;
  } catch (error) {
    console.error('Error fetching stories:', error);
    currentStories = [...defaultStories];
    buildStories();
    return false;
  }
};

// Add function to display individual story
const displayStory = async () => {
  const urlParams = new URLSearchParams(window.location.search);
  const storyId = urlParams.get('id');
  
  if (!storyId) return;

  try {
      const story = currentStories.find(s => s._id === parseInt(storyId));
      if (!story) {
        console.error('Story not found:', storyId);
        return;
      }
      
      // Update page content
      document.getElementById('story-title').textContent = story.title;
      document.getElementById('story-body').innerHTML = story.content;
      document.getElementById('story-image').src = story.image ?? `${apiURL}${story.image}`;
      
      const otherStories = currentStories.filter(s => s._id !== parseInt(storyId)).slice(0, 3); // Get up to 3 other stories
      
          
        const otherStoriesHTML = otherStories.map(story => `
          <div class="col col-12 col-md-6 col-xl-4 p-0">
            <div class="iconbox program-card flex-grow-1 relative flex-col iconbox-default iconbox-contents-show-onhover py-40 px-20 mb-30 items-center bg-white rounded-10 shadow-bottom lg:m-0">
              <h3 class="lqd-iconbox-heading text-center text-16 leading-1em mb-2">
                ${story.title}
              </h3>
              <div class="contents">
                <p>${story.summary}</p>
                <a href="story.html?id=${story._id}" class="btn btn-naked btn-icon-right btn-hover-reveal mt-1/5em mb-0">
                  <span class="btn-txt">Read more</span>
                  <span class="btn-icon"><i class="lqd-icn-ess icon-md-arrow-forward"></i></span>
                </a>
              </div>
            </div>
          </div>
        `).join('');
        
        document.getElementById('other-stories').innerHTML = `
          <div class="container">
            <h3 class="text-center mb-3" style="margin-top: -2rem;">Other Stories</h3>
            <div class="d-flex flex-wrap justify-content-between">
              ${otherStoriesHTML}
            </div>
          </div>
        `;
      
    
  } catch (error) {
    console.error('Error fetching story:', error);
  }
};

// Handle donate button visibility
function handleDonateButtonVisibility() {
    const hero = document.querySelector('#banner');
    const donateBtn = document.querySelector('.nav-donate-btn');
    
    if (!hero || !donateBtn) return;

    const heroBottom = hero.offsetTop + hero.offsetHeight;
    const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;

    if (scrollPosition > heroBottom) {
        donateBtn.classList.remove('opacity-0', 'pointer-events-none');
        donateBtn.classList.add('opacity-100', 'pointer-events-auto');
    } else {
        donateBtn.classList.add('opacity-0', 'pointer-events-none');
        donateBtn.classList.remove('opacity-100', 'pointer-events-auto');
    }
}

// Add scroll event listener
window.addEventListener('scroll', handleDonateButtonVisibility);
// Initialize on page load
window.addEventListener('load', handleDonateButtonVisibility);
